{% extends "base.html" %}

{% block content %}
<h1>Products</h1>
{% for product in products %}
<p>
  {{ product.name }}<br />
  <img src="{{ product.image_url }}" alt="{{ product.name }}" width="200" /><br />
  ${{ product.latest_price }} {{ product.price_diff }} {{product.latest_price_registered_at}}
  {% if user.is_authenticated %}
  <form class="follow-form" action="{% url 'products:toggle_following' product.id %}" method="post">
    {% csrf_token %}
    <input type="submit" value="{% if product.is_following %} Unfollow {% else %} Follow {% endif %}" />
  </form>
  {% endif %}
</p>
{% endfor %} {% endblock %}


{% block js %}
<script>
  document.querySelectorAll('.follow-form').forEach((it) => {
    it.addEventListener('submit', (e) => { 
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      const url = form.action;
      const method = form.method;
      fetch(url, {
        method,
        body: formData,
        headers: {
          'Content-Type': 'application/json',
          "X-Requested-With": "XMLHttpRequest",
          "HTTP_X_REQUESTED_WITH": "XMLHttpRequest",
          "X-CSRFToken": "{{ csrf_token }}",
        }})
        .then((response) => response.json())
        .then((data) => {
          const button = form.querySelector('input[type="submit"]');
          button.value = data.is_following ? 'Unfollow' : 'Follow';
        }).catch((error) => {console.log(error)});
    });
  });
</script>
{% endblock %}
